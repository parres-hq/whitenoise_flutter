name: Build APK

on:
  schedule:
    - cron: "0 22 * * *" # every day at 22:00 UTC, seems not to be working yet
  push:
    tags:
      - 'v*'            # run on tags like v0.1.4
  workflow_dispatch:     # manual run button in GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # ðŸŸ¢ Check for new commits in last 24h (only for nightly/scheduled runs)
      - name: Check for new commits
        if: github.event_name == 'schedule'
        run: |
          if [ -z "$(git log --since='24 hours ago' --oneline)" ]; then
            echo "No new commits in the last 24 hours. Skipping build."
            exit 0
          fi

      # ðŸŸ¢ Nightly build
      - name: Build Nightly APK
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          VERSION_NAME="0.1.3-$(date +'%Y-%m-%d')"
          VERSION_CODE=$(date +%s)
          flutter build apk --release \
            --build-name=$VERSION_NAME \
            --build-number=$VERSION_CODE

      # ðŸŸ¢ Release build (tagged)
      - name: Build Release APK
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION_CODE=$(date +%s)
          flutter build apk --release \
            --build-name=$TAG_NAME \
            --build-number=$VERSION_CODE

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk